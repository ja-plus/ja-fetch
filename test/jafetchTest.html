<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="btns">
    <div id="testAbortController">test AbortController</div>
    <div id="interceptorAbortController">test interceptor AbortController</div>
    <div id="commonCancelRequest">test interceptor commonCancelRequest</div>
    <div id="commonThrottleRequest">test interceptor commonThrottleRequest</div>
    <div id="commonParallelRequest">test interceptor commonParallelRequest</div>
    <div id="commonTimeoutRequest">test interceptor commonTimeoutRequest</div>
  </div>
</body>
<script type="module">
  /* -------basic request---------------*/
  import http from '../lib/ja-fetch.js';
  import h from './h.js';
  let service = http.create({ baseURL: 'http://localhost:8080' });
  service
    .request('/getTestData', {
      method: 'GET',
      params: { type: 'aa', data: 'ddd' },
      mode: 'cors',
    })
    .then(res => {
      console.log(res, 'request get: ok');
      document.body.append(h('p', 'request GET: ok,' + JSON.stringify(res)));
    });
  service
    .get('/getTestData', {
      params: { type: 'aa', data: 'ddd' },
      mode: 'cors',
      // credentials: 'include',
      // responseType: 'text'
    })
    .then(res => {
      console.log(res, 'get: ok');
      document.body.append(h('p', 'GET: ok,' + JSON.stringify(res)));
    });

  service
    .post('/postTestData', {
      params: { id: '11' },
      body: { type: 'json' },
      mode: 'cors',
    })
    .then(res => {
      console.log(res, 'post json: ok');
      document.body.append(h('p', 'POST json: ok,' + JSON.stringify(res)));
    });

  let formData = new FormData();
  formData.append('type', 'formData');

  service
    .post('/postTestData', {
      params: { id: '11' },
      body: formData,
      mode: 'cors',
    })
    .then(res => {
      console.log(res, 'post form data: ok');
      document.body.append(h('p', 'POST form data: ok,' + JSON.stringify(res)));
    });

  service
    .put('/putTestData', {
      params: { id: 'pp' },
      body: { type: 'put' },
      mode: 'cors',
    })
    .then(res => {
      console.log(res, 'put json: ok');
      document.body.append(h('p', 'PUT json: ok,' + JSON.stringify(res)));
    });

  service
    .del('/delTestData', {
      params: { id: 'del' },
      body: { type: 'delete' },
      mode: 'cors',
    })
    .then(res => {
      console.log(res, 'delete : ok');
      document.body.append(h('p', 'DELETE : ok,' + JSON.stringify(res)));
    });
</script>

<script type="module">
  /* ------------interceptors-----------------*/
  import jafetch from '../lib/ja-fetch.js';
  import h from './h.js';
  const Service = jafetch.create({
    mode: 'cors',
    // credentials: 'include' // cookie
  });

  Service.interceptors.request.use(
    (url, config) => {
      config.headers.userToken = '11111';
      return config;
    },
    err => {
      console.log('request interceptor err:', err);
      return Promise.reject(err);
    },
  );

  Service.interceptors.response.use(
    (data, { init }) => {
      if (data.code === 1) {
        console.log(data, init, 'response interceptor: ok');
        document.body.append(h('p', 'response interceptor: ok,' + JSON.stringify(data)));
        return data;
      } else {
        return Promise.reject('response.data.code is ' + data.code);
      }
    },
    err => {
      console.log('response interceptor err:', err);
      return Promise.reject(err);
    },
  );
  Service.get('http://localhost:8080/getTestData', {
    params: { type: 'aa' },
    mode: 'cors',
    // credentials: 'include',
    // responseType: 'text'
  })
    .then(res => {
      console.log(res, 'interceptor get: ok');
      document.body.append(h('p', 'interceptor GET: ok,' + JSON.stringify(res)));
    })
    .catch(err => {
      console.error('interceptor get: fail', err);
      document.body.append(h('p', 'interceptor GET: fail,' + JSON.stringify(err)));
    });
  /** remove interceptor*/
  // Service.interceptors.response.remove();

  Service.post('http://localhost:8080/postTestData', {
    params: { type: 'post param' },
    headers: {
      // 'Content-Type': 'text/plain',
    },
    body: { type: 'post' },
    mode: 'cors',
    // credentials: 'include',
    // responseType: 'text'
  })
    .then(res => {
      console.log(res, 'interceptor post: ok');
      document.body.append(h('p', ' interceptor POST: ok,' + JSON.stringify(res)));
    })
    .catch(err => {
      console.error('interceptor post: fail', err);
      document.body.append(h('p', 'interceptor POST: fail,' + JSON.stringify(err)));
    });

  // Service.get('http://localhost:8080/timeoutTestData', {
  //   params: {
  //     timeout: 2000,
  //   },
  // })
  //   .then(res => {
  //     console.log('res', res);
  //   })
  //   .catch(err => {
  //     console.log(err);
  //   });
</script>

<script type="module">
  /* test abortController*/
  import jafetch from '../lib/ja-fetch.js';
  import h from './h.js';
  const fetchBtn = h('button', 'fetch');
  const abortBtn = h('button', 'AbortController');
  document.querySelector('#testAbortController').append(fetchBtn, abortBtn);
  let controller;
  fetchBtn.addEventListener('click', () => {
    if (controller) {
      controller.abort();
      console.log('取消上次请求');
    }
    console.log('abortController 发起fetch 请求... 4s后返回结果');
    controller = new AbortController();
    // console.log('AbortController.signal',  signal);
    jafetch
      .get('http://localhost:8080/timeoutTestData', {
        params: { timeout: 4000 },
        signal: controller.signal,
      })
      .then(response => {
        console.log('abortController fetch response :>> ', response);
      })
      .catch(err => {
        console.warn('abortController fetch请求已被取消', err);
      });
  });
  abortBtn.addEventListener('click', () => {
    if (!controller) {
      console.warn('abortController 请先发起请求');
      return;
    }
    console.log('abortController 使用AbortController 取消请求');
    controller.abort();
  });
</script>


<script type="module">
  /* test interceptor abortController*/
  import jafetch from '../lib/ja-fetch.js';
  import h from './h.js';
  let cacheArr = [];
  jafetch.interceptors.request.use((url, config) => {
    cacheArr.forEach(item => {
      if (item.url === url) {
        item.controller.abort();
        item.canceled = true;
      }
    });
    let abController = new AbortController();
    config.signal = abController.signal;
    cacheArr.push({
      url,
      controller: abController,
      canceled: false,
    });
  });

  jafetch.interceptors.response.use((url, { config }) => {
    cacheArr = cacheArr.filter(item => !item.canceled); // 仅保留未清除的,对象回收
  });

  const fetchBtn = h('button', 'fetch');
  const abortBtn = h('button', 'AbortController');
  document.querySelector('#interceptorAbortController').append(fetchBtn, abortBtn);
  fetchBtn.addEventListener('click', () => {
    console.log('发起fetch 请求... 4s后返回结果');
    jafetch
      .get('http://localhost:8080/timeoutTestData', {
        params: { timeout: 4000 },
      })
      .then(response => {
        console.log('interceptor AbortController fetch response :>> ', response);
      })
      .catch(err => {
        console.warn('interceptor AbortController fetch请求已被取消', err);
      });
  });
  abortBtn.addEventListener('click', () => {
    console.log('interceptor AbortController 使用AbortController 取消所有请求');
    cacheArr.forEach(item => {
      item.controller.abort();
    });
  });
</script>
<script type="module">
  // multi interceptors
  import jafetch from '../lib/ja-fetch.js';
  import h from './h.js';
  const Service = jafetch.create();

  /**增加一个请求拦截器*/
  Service.interceptors.request.use(
    (url, config) => {
      config.headers.HAHAHA = '1';
      return config;
    },
    err => {
      console.log('request multi interceptor err1', err);
      // return Promise.resolve() // will not jump to next interceptors.request onRejected func
      return Promise.reject(err); // will jump to next
    },
  );
  /**第二个请求拦截器*/
  Service.interceptors.request.use(
    (url, config) => {
      config.headers.HAHAAH2 = '2';
      return config;
    },
    err => {
      console.log('request multi interceptor err2', err);
      // return Promise.reject(err) // will jump to jafetch.xxx().catch()
      // return Promise.resolve() // will jump to jafetch.xxx().then()
    },
  );

  /**响应拦截器*/
  Service.interceptors.response.use(
    (data, conf) => {
      console.log('response multi interceptor1 data:', data, conf);
      data.addKey1 = 2;
      data.a.a; // throw error
      return data;
      // return Promise.reject('aaa');
    },
    err => {
      console.log('response multi interceptor1 err:', err);
      return Promise.reject(err);
    },
  );
  /**第二个响应拦截器*/
  Service.interceptors.response.use(
    data => {
      console.log('response multi interceptor2 data:', data);
      data.addKey2 = 2;
      return data;
      // return Promise.reject('aaaa')
    },
    err => {
      console.log('response multi interceptor2 err:', err);
      return Promise.reject(err);
      // return Promise.resolve('1')
    },
  );

  Service.get('http://localhost:8080/getTestData', {
    params: { type: 'aa' },
    // mode: 'cors',
  })
    .then(res => {
      console.log(res, 'multi interceptor get: ok');
      document.body.append(h('p', 'multi interceptor GET: ok,' + JSON.stringify(res)));
    })
    .catch(err => {
      console.error('multi interceptor get: err', err);
      document.body.append(h('p', 'multi interceptor GET: err,' + JSON.stringify(err)));
    });
</script>
<script type="module">
  /* test interceptor commonCancelRequest*/
  import jafetch from '../lib/ja-fetch.js';
  import { commonCancelRequest } from '../preset/interceptors.js';
  import h from './h.js';
  let ServiceAB = jafetch.create();
  ServiceAB.interceptors.use(
    commonCancelRequest(
      (storedRequest, nowRequest) => {
        return storedRequest.url === nowRequest.url;
      },
      { notInterceptKey: '__not_cancel__' },
    ),
  );

  const fetchBtn = h('button', 'fetch');
  document.querySelector('#commonCancelRequest').append(fetchBtn);
  fetchBtn.addEventListener('click', () => {
    console.log('commonCancelRequest 发起fetch 请求... 1s后返回结果');
    ServiceAB.get('http://localhost:8080/timeoutTestData', {
      params: { timeout: 1000 },
      // notCancel: true,
      // __not_cancel__: true,
    })
      // ServiceAB.get('http://localhost:8080/setStatusCode', {
      //   params: { code: 502 },
      // })
      .then(response => {
        console.log('commonCancelRequest fetch response :>> ', response);
      })
      .catch(err => {
        console.warn('commonCancelRequest fetch请求失败', err);
      });
  });
</script>
<script type="module">
  /* test interceptor throttle */
  import jafetch from '../lib/ja-fetch.js';
  import { commonThrottleRequest } from '../preset/interceptors.js';
  import h from './h.js';
  let ServiceAB = jafetch.create();
  ServiceAB.interceptors.use(commonThrottleRequest(null, { notInterceptKey: '__not_throttle__' }));

  const fetchBtn = h('button', 'fetch');
  document.querySelector('#commonThrottleRequest').append(fetchBtn);
  fetchBtn.addEventListener('click', () => {
    console.log('commonThrottleRequest 发起fetch 请求... 1s后返回结果');
    ServiceAB.get('http://localhost:8080/timeoutTestData', {
      params: { timeout: 1000 },
      notThrottle: true,
      // __not_throttle__: true,
    })
      // ServiceAB.get('http://localhost:8080/setStatusCode', {
      //   params: { code: 500 },
      // })
      .then(response => {
        console.log('commonThrottleRequest fetch response :>> ', response);
      })
      .catch(err => {
        console.warn('commonThrottleRequest fetch 请求失败：', err);
      });
  });
</script>
<script type="module">
  import http from '../lib/ja-fetch.js';
  import { commonParallelRequest } from '../preset/interceptors.js';
  import h from './h.js';
  let serviceParallel = http.create();
  serviceParallel.interceptors.use(commonParallelRequest({ limit: 2 }));

  const parallelFetchBtn = h('button', 'parallelFetch');
  document.querySelector('#commonParallelRequest').append(parallelFetchBtn);
  parallelFetchBtn.addEventListener('click', () => {
    console.log('commonParallelRequest 发起5个请求');
    for (let i = 0; i < 5; i++) {
      serviceParallel
        .get('http://localhost:8080/timeoutTestData', {
          params: { timeout: 5000 - i * 1000, q: i },
        })
        .then(response => {
          console.log('commonParallelRequest fetch response :>>', response);
        })
        .catch(err => {
          console.warn('commonParallelRequest fetch 请求失败：', err);
        });
    }
  });
</script>
<script type="module">
  import http from '../lib/ja-fetch.js';
  import { commonTimeoutRequest } from '../preset/interceptors.js';
  import h from './h.js';
  let serviceTimeout = http.create();
  serviceTimeout.interceptors.use(commonTimeoutRequest({ ms: 3000 }));

  const timeoutFetchBtn = h('button', 'timeoutFetch');
  document.querySelector('#commonTimeoutRequest').append(timeoutFetchBtn);
  timeoutFetchBtn.addEventListener('click', () => {
    serviceTimeout
      .get('http://localhost:8080/timeoutTestData', {
        params: { timeout: 5000 },
      })
      .then(response => {
        console.log('commonTimeoutRequest fetch response :>>', response);
      })
      .catch(err => {
        console.warn('commonTimeoutRequest fetch 请求失败：', err);
      });
  });
</script>
<script type="module">
  import http from '../lib/ja-fetch.js';
  import h from './h.js';
  /**@type {HTMLElement}*/
  let uploadFileBtn = h('button', 'uploadFile');
  uploadFileBtn.addEventListener('click', fetch);
  document.body.appendChild(uploadFileBtn);

  const formData = new FormData();
  formData.append('file', new File(['hello world'], 'file.txt', { type: 'text/plain' }));
  formData.append('text', 'hello');
  function fetch() {
    http
      .post('http://localhost:8080/uploadFile', {
        params: { type: 'post' },
        body: formData,
      })
      .then(res => {
        console.log('uploadFile OK :', res);
      });
  }
  fetch();
</script>

</html>